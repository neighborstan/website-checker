name: Server Monitor

on:
  schedule:
    - cron: "*/5 * * * *"  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
  workflow_dispatch:       # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤
concurrency:
  group: monitor
  cancel-in-progress: false  # –Ω–µ –æ—Ç–º–µ–Ω—è—Ç—å —Ç–µ–∫—É—â–∏–µ –∑–∞–ø—É—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –Ω–æ–≤–æ–≥–æ

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # –†–∞–∑—Ä–µ—à–∞–µ–º Actions –¥–µ–ª–∞—Ç—å git push
      actions: write  # –ü—Ä–∞–≤–∞ –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ actions

    steps:
      - name: üõ†Ô∏è –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v3
        with:
          persist-credentials: true  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –¥–ª—è git push

      - name: üîë –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç
        run: chmod +x monitoring/check_sites.sh

      - name: üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          SITES: ${{ vars.SITES }}
        run: monitoring/check_sites.sh

      - name: üìÇ –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --rebase --autostash origin main
          git add monitoring/site_status.log monitoring/site_monitor.log  # –î–æ–±–∞–≤–ª—è–µ–º –æ–±–∞ —Ñ–∞–π–ª–∞
          git commit -m "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–∞–π—Ç–æ–≤ –∏ –ª–æ–≥–æ–≤" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          git push origin main

      - name: üßπ –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤, –æ—Å—Ç–∞–≤–ª—è—è 10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
        run: |
          TOKEN=${{ secrets.ACTIONS_DELETE_TOKEN }}
          REPO=${{ github.repository }}

          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ ID –≤—Å–µ—Ö –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤ (completed), —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
          RUN_IDS=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$REPO/actions/runs?per_page=100" | \
            jq -r '.workflow_runs | map(select(.status == "completed")) | sort_by(.created_at) | .[:-10] | .[].id')

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —á—Ç–æ —É–¥–∞–ª—è—Ç—å
          if [ -z "$RUN_IDS" ]; then
            echo "‚úÖ –ù–µ—Ç —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è."
            exit 0
          fi

          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø—É—Å–∫–∏
          for ID in $RUN_IDS; do
            echo "üöÆ –£–¥–∞–ª—è–µ–º –∑–∞–ø—É—Å–∫ $ID..."
            curl -X DELETE -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/$REPO/actions/runs/$ID"
          done

          echo "‚úÖ –í—Å–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–ø—É—Å–∫–∏ —É–¥–∞–ª–µ–Ω—ã."
      

